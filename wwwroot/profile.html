<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ace Job Agency - Profile</title>
    <style>
        * {
  margin: 0;
   padding: 0;
   box-sizing: border-box;
   }

    body {
   font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
     background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
       min-height: 100vh;
padding: 20px;
   }

      .container {
       max-width: 800px;
   margin: 0 auto;
       background: white;
padding: 40px;
  border-radius: 10px;
     box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .back-home {
            margin-bottom: 20px;
        }

      .back-home a {
    color: #667eea;
      text-decoration: none;
            font-weight: 500;
            display: inline-flex;
      align-items: center;
     gap: 5px;
        }

        .back-home a:hover {
       text-decoration: underline;
        }

        h1 {
     color: #333;
       margin-bottom: 30px;
 text-align: center;
  }

        .profile-section {
     margin-bottom: 30px;
    padding: 20px;
         background: #f8f9fa;
 border-radius: 5px;
    }

   .profile-section h2 {
   color: #667eea;
       margin-bottom: 15px;
       font-size: 20px;
     }

.profile-field {
       margin-bottom: 15px;
 display: flex;
  }

    .profile-field label {
     font-weight: 600;
       color: #333;
    width: 180px;
   }

   .profile-field value {
   color: #666;
        }

  .file-links {
  margin-top: 10px;
 }

   .file-links a {
   color: #667eea;
       text-decoration: none;
    font-weight: 500;
        margin-right: 15px;
      }

        .file-links a:hover {
       text-decoration: underline;
        }

 .button-group {
   display: flex;
gap: 10px;
       margin-top: 20px;
flex-wrap: wrap;
        }

  button, .btn {
 padding: 12px 24px;
  border: none;
   border-radius: 5px;
 font-size: 14px;
font-weight: 600;
   cursor: pointer;
       transition: transform 0.2s;
   text-decoration: none;
         display: inline-block;
 }

        .btn-primary {
   background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
 }

   .btn-secondary {
  background: #6c757d;
  color: white;
 }

        .btn-info {
        background: #17a2b8;
     color: white;
   }

        .btn-home {
          background: #28a745;
   color: white;
        }

  button:hover, .btn:hover {
     transform: translateY(-2px);
        }

 .success {
   background-color: #d4edda;
            border: 1px solid #c3e6cb;
   color: #155724;
padding: 15px;
       border-radius: 5px;
 margin-bottom: 20px;
 }

 .alert-error {
 background-color: #f8d7da;
 border: 1px solid #f5c6cb;
       color: #721c24;
padding: 15px;
     border-radius: 5px;
 margin-bottom: 20px;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="back-home">
            <a href="index.html">‚Üê Back to Home</a>
        </div>

      <h1>Welcome to Your Profile</h1>

     <div id="successMessage" style="display: none;" class="success"></div>
     <div id="errorMessage" style="display: none;" class="alert-error"></div>

        <!-- Password Expiration Warning -->
<div id="passwordWarning" style="display: none; background-color: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
   <strong>‚ö†Ô∏è Password Warning:</strong>
    <span id="passwordWarningMessage"></span>
       <a href="change-password.html" style="color: #856404; font-weight: bold; text-decoration: underline; margin-left: 10px;">Change Password Now</a>
   </div>

   <div class="profile-section">
    <h2>Personal Information</h2>
  <div id="profileData"></div>
  </div>

        <div class="profile-section">
  <h2>Files</h2>
      <div id="filesData"></div>
  </div>

<div class="button-group">
        <a href="index.html" class="btn btn-home">üè† Home</a>
   <button class="btn-primary" onclick="window.location.href='edit-profile.html'">Edit Profile</button>
     <button class="btn-primary" onclick="window.location.href='change-password.html'">Change Password</button>
     <a href="audit-logs.html" class="btn btn-info">View Audit Logs</a>
 <button class="btn-secondary" onclick="logout()">Logout</button>
 </div>
    </div>

    <script>
        async function loadProfile() {
  try {
     const response = await fetch('https://localhost:7134/api/member/profile', {
         method: 'GET',
        credentials: 'include'
     });

if (response.ok) {
      const data = await response.json();
 displayProfile(data.profile);
               displayPasswordWarning(data.passwordStatus);
  } else if (response.status === 401) {
     window.location.href = 'login.html';
   } else {
document.getElementById('errorMessage').textContent = 'Failed to load profile';
    document.getElementById('errorMessage').style.display = 'block';
 }
   } catch (error) {
 document.getElementById('errorMessage').textContent = 'An error occurred';
   document.getElementById('errorMessage').style.display = 'block';
 }
      }

        function displayPasswordWarning(passwordStatus) {
    if (!passwordStatus) return;

            const warningDiv = document.getElementById('passwordWarning');
 const messageSpan = document.getElementById('passwordWarningMessage');

if (passwordStatus.shouldWarn && passwordStatus.daysUntilExpiration > 0) {
    //  Warning: password expiring soon
       let message = `Your password will expire in ${passwordStatus.daysUntilExpiration} day(s). `;
 message += `Please change it soon to avoid being locked out.`;
      messageSpan.textContent = message;
 warningDiv.style.display = 'block';
    } else if (!passwordStatus.canChange && passwordStatus.hoursUntilCanChange > 0) {
        // Info: cannot change password yet (minimum age)
      warningDiv.style.backgroundColor = '#d1ecf1';
  warningDiv.style.borderColor = '#bee5eb';
     warningDiv.style.color = '#0c5460';
        let message = `You recently changed your password. You can change it again in ${passwordStatus.hoursUntilCanChange} hour(s).`;
       messageSpan.textContent = message;
        warningDiv.style.display = 'block';
    }
        }

function displayProfile(profile) {
  // Helper function to convert UTC to Singapore Time
         function toSingaporeTime(utcDateString) {
      const date = new Date(utcDateString);
     const singaporeTime = new Date(date.getTime() + (8 * 60 * 60 * 1000));
       
       const day = singaporeTime.getUTCDate().toString().padStart(2, '0');
       const month = (singaporeTime.getUTCMonth() + 1).toString().padStart(2, '0');
      const year = singaporeTime.getUTCFullYear();
      
        let hours = singaporeTime.getUTCHours();
     const minutes = singaporeTime.getUTCMinutes().toString().padStart(2, '0');
const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
         hours = hours ? hours : 12;
      const hoursStr = hours.toString().padStart(2, '0');
 
     return `${day}/${month}/${year}, ${hoursStr}:${minutes} ${ampm} SGT`;
    }

    function toSingaporeDate(utcDateString) {
     const date = new Date(utcDateString);
  const singaporeTime = new Date(date.getTime() + (8 * 60 * 60 * 1000));
      
       const day = singaporeTime.getUTCDate().toString().padStart(2, '0');
    const month = (singaporeTime.getUTCMonth() + 1).toString().padStart(2, '0');
  const year = singaporeTime.getUTCFullYear();
         
 return `${day}/${month}/${year}`;
  }

  const profileHtml = `
  <div class="profile-field">
 <label>Name:</label>
  <span>${profile.firstName} ${profile.lastName}</span>
     </div>
   <div class="profile-field">
    <label>Email:</label>
       <span>${profile.email}</span>
       </div>
      <div class="profile-field">
     <label>Gender:</label>
  <span>${profile.gender}</span>
   </div>
  <div class="profile-field">
     <label>NRIC:</label>
    <span>${profile.nricDecrypted}</span>
  </div>
  <div class="profile-field">
  <label>Date of Birth:</label>
  <span>${toSingaporeDate(profile.dateOfBirth)}</span>
</div>
   <div class="profile-field">
    <label>Member Since:</label>
<span>${toSingaporeDate(profile.createdDate)}</span>
    </div>
 ${profile.lastLoginDate ? `
  <div class="profile-field">
      <label>Last Login:</label>
 <span>${toSingaporeTime(profile.lastLoginDate)}</span>
 </div>
  ` : ''}
   ${profile.whoAmI ? `
   <div class="profile-field">
  <label>About Me:</label>
   <span>${profile.whoAmI}</span>
   </div>
       ` : ''}
   `;
  document.getElementById('profileData').innerHTML = profileHtml;

       // Display file links
 const filesHtml = `
    <div class="file-links">
 <strong>Resume:</strong> 
       <a href="https://localhost:7134/api/member/download-resume" target="_blank">Download Resume</a>
       </div>
      ${profile.photoPath ? `
           <div class="file-links">
<strong>Photo:</strong> 
        <a href="https://localhost:7134/api/member/download-photo" target="_blank">Download Photo</a>
    </div>
           ` : '<p style="color: #666; margin-top: 10px;">No photo uploaded</p>'}
        `;
     document.getElementById('filesData').innerHTML = filesHtml;
}

      async function logout() {
   try {
  const response = await fetch('https://localhost:7134/api/auth/logout', {
     method: 'POST',
       credentials: 'include'
});

     if (response.ok) {
   window.location.href = 'index.html';
 }
  } catch (error) {
document.getElementById('errorMessage').textContent = 'Logout failed';
  document.getElementById('errorMessage').style.display = 'block';
   }
 }

      // Load profile on page load
 loadProfile();

// Session validation on page visibility change
// When user switches back to this tab, immediately check if session is still valid
document.addEventListener('visibilitychange', async () => {
    if (!document.hidden) {
        // User switched back to this tab - check session immediately
    try {
     const response = await fetch('https://localhost:7134/api/member/profile', {
     method: 'GET',
     credentials: 'include'
     });
         
  if (response.status === 401) {
 // Session invalid - redirect immediately
   window.location.href = 'login.html';
}
        } catch (error) {
            console.error('Session check error:', error);
   }
    }
});

// NOTE: Session is also validated automatically on EVERY user interaction
// The SessionValidationMiddleware validates sessions on EVERY API request.
// When a user clicks any link or navigates, the middleware will immediately
// detect if the session has been invalidated and redirect to login.
    </script>
</body>
</html>
