<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ace Job Agency - Audit Logs</title>
    <style>
        * {
          margin: 0;
    padding: 0;
        box-sizing: border-box;
   }

  body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
        padding: 20px;
        }

     .container {
         max-width: 1200px;
 margin: 0 auto;
     background: white;
    padding: 40px;
 border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
   }

   h1 {
    color: #333;
     margin-bottom: 30px;
       text-align: center;
        }

    .back-link {
   margin-bottom: 20px;
    }

        .back-link a {
            color: #667eea;
     text-decoration: none;
   font-weight: 500;
        }

        .back-link a:hover {
     text-decoration: underline;
      }

        .alert-error {
    background-color: #f8d7da;
 border: 1px solid #f5c6cb;
   color: #721c24;
        padding: 15px;
            border-radius: 5px;
       margin-bottom: 20px;
        }

        .logs-table {
   width: 100%;
       border-collapse: collapse;
        margin-top: 20px;
   }

        .logs-table th,
        .logs-table td {
padding: 12px;
    text-align: left;
   border-bottom: 1px solid #ddd;
     }

        .logs-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

 .logs-table tr:hover {
            background-color: #f8f9fa;
        }

      .action-badge {
            padding: 4px 8px;
  border-radius: 4px;
     font-size: 12px;
   font-weight: 600;
    display: inline-block;
     }

   .action-success {
     background-color: #d4edda;
  color: #155724;
        }

   .action-failed {
     background-color: #f8d7da;
    color: #721c24;
    }

        .action-info {
  background-color: #d1ecf1;
     color: #0c5460;
        }

        .loading {
          text-align: center;
padding: 40px;
     color: #666;
 }

        .no-logs {
     text-align: center;
      padding: 40px;
    color: #666;
         font-style: italic;
  }

        .export-btn {
        padding: 10px 20px;
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
   color: white;
    border: none;
  border-radius: 5px;
    font-size: 14px;
 font-weight: 600;
          cursor: pointer;
    margin-bottom: 20px;
        }

    .export-btn:hover {
opacity: 0.9;
      }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
   <a href="profile.html">&larr; Back to Profile</a>
</div>

        <h1>Your Activity Audit Logs</h1>

        <button class="export-btn" onclick="exportLogs()">Export to CSV</button>

 <div id="errorMessage" style="display: none;" class="alert-error"></div>
   <div id="loadingMessage" class="loading">Loading audit logs...</div>
        <div id="logsContainer"></div>
    </div>

    <script>
        async function checkAuth() {
     try {
     const response = await fetch('https://localhost:7134/api/member/profile', {
    method: 'GET',
credentials: 'include'
         });
  
   if (!response.ok) {
 window.location.href = 'login.html';
   }
  } catch (error) {
  window.location.href = 'login.html';
            }
        }

        async function loadAuditLogs() {
     try {
      const response = await fetch('https://localhost:7134/api/member/audit-logs', {
       method: 'GET',
         credentials: 'include'
        });

         document.getElementById('loadingMessage').style.display = 'none';

  if (response.ok) {
   const logs = await response.json();
       displayLogs(logs);
     } else if (response.status === 401) {
           window.location.href = 'login.html';
         } else {
             document.getElementById('errorMessage').textContent = 'Failed to load audit logs';
       document.getElementById('errorMessage').style.display = 'block';
    }
         } catch (error) {
     document.getElementById('loadingMessage').style.display = 'none';
         document.getElementById('errorMessage').textContent = 'An error occurred while loading logs';
   document.getElementById('errorMessage').style.display = 'block';
      }
      }

        function convertToSingaporeTime(utcDateString) {
  const date = new Date(utcDateString);
            // Convert to Singapore Time (UTC+8)
      const singaporeTime = new Date(date.getTime() + (8 * 60 * 60 * 1000));
            
     // Format: DD/MM/YYYY, HH:MM:SS AM/PM
            const day = singaporeTime.getUTCDate().toString().padStart(2, '0');
          const month = (singaporeTime.getUTCMonth() + 1).toString().padStart(2, '0');
    const year = singaporeTime.getUTCFullYear();
            
    let hours = singaporeTime.getUTCHours();
     const minutes = singaporeTime.getUTCMinutes().toString().padStart(2, '0');
      const seconds = singaporeTime.getUTCSeconds().toString().padStart(2, '0');
          
            const ampm = hours >= 12 ? 'PM' : 'AM';
   hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
        const hoursStr = hours.toString().padStart(2, '0');
      
            return `${day}/${month}/${year}, ${hoursStr}:${minutes}:${seconds} ${ampm} SGT`;
        }

        function displayLogs(logs) {
            const container = document.getElementById('logsContainer');
    
   if (logs.length === 0) {
            container.innerHTML = '<div class="no-logs">No audit logs found</div>';
    return;
     }

      let tableHtml = `
    <table class="logs-table">
     <thead>
         <tr>
          <th>Timestamp (Singapore Time)</th>
  <th>Action</th>
    <th>IP Address</th>
       <th>Details</th>
            </tr>
       </thead>
          <tbody>
     `;

       logs.forEach(log => {
     const actionClass = getActionClass(log.action);
       const timestamp = convertToSingaporeTime(log.timestamp);
     
        tableHtml += `
       <tr>
   <td>${timestamp}</td>
       <td><span class="action-badge ${actionClass}">${formatAction(log.action)}</span></td>
    <td>${log.ipAddress}</td>
   <td>${log.details || '-'}</td>
     </tr>
     `;
      });

      tableHtml += `
   </tbody>
   </table>
`;

  container.innerHTML = tableHtml;
      }

     function getActionClass(action) {
        if (action.includes('SUCCESS')) return 'action-success';
      if (action.includes('FAILED') || action.includes('ERROR') || action.includes('LOCKED')) return 'action-failed';
   return 'action-info';
        }

        function formatAction(action) {
  return action.replace(/_/g, ' ');
        }

        async function exportLogs() {
 try {
 const response = await fetch('https://localhost:7134/api/member/audit-logs', {
   method: 'GET',
 credentials: 'include'
     });

     if (response.ok) {
     const logs = await response.json();
 
   // Create CSV content with Singapore Time
    let csv = 'Timestamp (Singapore Time),Action,IP Address,User Agent,Details\n';
      logs.forEach(log => {
   const timestamp = convertToSingaporeTime(log.timestamp);
csv += `"${timestamp}","${log.action}","${log.ipAddress}","${log.userAgent}","${log.details || ''}"\n`;
       });

     // Download CSV file
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
       a.href = url;
       a.download = `audit-logs-${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
       a.click();
      document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
  }
  } catch (error) {
  alert('Failed to export logs');
          }
   }

  // Check authentication and load logs
   checkAuth();
      loadAuditLogs();
    </script>
</body>
</html>
